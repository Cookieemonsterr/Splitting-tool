<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Store Splitter</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 24px; max-width: 860px }
    .card { border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px; margin-bottom: 16px; box-shadow: 0 4px 16px rgba(0,0,0,.04) }
    h1 { margin: 0 0 8px }
    label { display: block; font-weight: 600; margin-top: 12px }
    input[type="file"] { margin-top: 8px }
    button { margin-top: 16px; padding: 10px 16px; border: 0; border-radius: 10px; cursor: pointer }
    .primary { background:#16a34a; color:white }
    .muted { color:#64748b; font-size: 12px }
    .row { display:flex; gap:16px; align-items:center; flex-wrap:wrap }
  </style>
  <!-- Libraries: CSV parser, Excel reader, ZIP builder, file saver -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
</head>
<body>
  <h1>Store CSV Splitter</h1>
  <div class="card">
    <div class="row">
      <div style="flex:1 1 320px">
        <label>Master CSV</label>
        <input id="master" type="file" accept=".csv" />
        <div class="muted">Must include a header column like <code>Store_No</code>.</div>
      </div>
      <div style="flex:1 1 320px">
        <label>Optional mapping (Excel/CSV) for renaming to Careem ID</label>
        <input id="mapping" type="file" accept=".xlsx,.xls,.csv" />
        <div class="muted">We’ll auto-detect columns (Store Code & Careem ID).</div>
      </div>
    </div>

    <div class="row">
      <div>
        <label>Store column name</label>
        <input id="storeCol" type="text" value="Store_No" />
      </div>
      <div>
        <label>Output filename pattern</label>
        <select id="pattern">
          <option value="store">STORE_CODE.csv</option>
          <option value="careem">CAREEM_ID.csv (if mapping matches, else STORE_CODE.csv)</option>
        </select>
      </div>
    </div>

    <button class="primary" id="runBtn">Split & Download ZIP</button>
    <div id="log" class="muted" style="margin-top:10px"></div>
  </div>

<script>
const $ = (id)=>document.getElementById(id);
const log = (msg)=>{ $('log').textContent = msg };

async function readFileAsText(file){
  return new Promise((res, rej)=>{
    const r = new FileReader();
    r.onload = () => res(r.result);
    r.onerror = rej;
    r.readAsText(file);
  });
}

async function parseMapping(file){
  if(!file) return {};
  const name = file.name.toLowerCase();
  // CSV mapping
  if(name.endsWith('.csv')){
    const text = await readFileAsText(file);
    const { data, meta } = Papa.parse(text, { header:true, skipEmptyLines:true });
    return buildMappingFromRows(data);
  }
  // Excel mapping
  const buf = await file.arrayBuffer();
  const wb = XLSX.read(buf, { type: 'array' });
  const sheetName = wb.SheetNames[0];
  const rows = XLSX.utils.sheet_to_json(wb.Sheets[sheetName], { defval:"" });
  return buildMappingFromRows(rows);
}

function buildMappingFromRows(rows){
  if(!rows || !rows.length) return {};
  const headers = Object.keys(rows[0]);
  const codeCol = guessStoreCodeCol(headers, rows);
  const idCol   = guessIdCol(headers, rows, codeCol);
  const map = {};
  rows.forEach(r=>{
    const code = String((r[codeCol]||"")).trim().toUpperCase();
    const id   = String((r[idCol]||"")).trim();
    if(/^[A-Z]\d{3}$/.test(code) && /^\d+$/.test(id)) map[code]=id;
  });
  return map;
}

function guessStoreCodeCol(headers, rows){
  let best=null, score=-1;
  headers.forEach(h=>{
    const s = rows.reduce((acc,r)=>acc + ( /^[A-Z]\d{3}$/.test(String(r[h]||"").trim().toUpperCase()) ? 1:0 ), 0);
    if(s>score){score=s;best=h;}
  });
  return best || headers[0];
}

function guessIdCol(headers, rows, exclude){
  let best=null, score=-1;
  headers.forEach(h=>{
    if(h===exclude) return;
    const s = rows.reduce((acc,r)=>acc + ( /^\d+$/.test(String(r[h]||"").trim()) ? 1:0 ), 0);
    if(s>score){score=s;best=h;}
  });
  return best || headers.find(h=>h!==exclude) || headers[0];
}

function toCsv(headers, rows){
  const esc = v=>{
    const s = v==null ? "" : String(v);
    return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
  };
  return [headers.join(','), ...rows.map(r=>headers.map(h=>esc(r[h])).join(','))].join('\n');
}

$('runBtn').onclick = async ()=>{
  try{
    const master = $('master').files[0];
    if(!master) { alert('Please choose the master CSV'); return; }
    const mappingFile = $('mapping').files[0];
    const storeCol = $('storeCol').value.trim();
    const pattern = $('pattern').value;

    log('Reading files…');
    const [text, mapping] = await Promise.all([
      readFileAsText(master),
      parseMapping(mappingFile)
    ]);

    const parsed = Papa.parse(text, { header:true, skipEmptyLines:true });
    if(parsed.errors?.length){
      console.warn(parsed.errors);
    }
    const rows = parsed.data;
    if(!rows.length) { alert('Master CSV is empty'); return; }

    // Group rows by store code
    const storeField = storeCol || 'Store_No';
    const groups = {};
    rows.forEach(r=>{
      const code = String(r[storeField] ?? "").trim().toUpperCase();
      if(!code) return;
      (groups[code] ||= []).push(r);
    });

    // Prepare ZIP
    const zip = new JSZip();
    const headers = parsed.meta.fields || Object.keys(rows[0]||{});

    let files = 0, renamed = 0;
    for(const [code, rowsForStore] of Object.entries(groups)){
      let filename;
      if(pattern==='careem' && mapping[code]){
        filename = `${mapping[code]}.csv`; renamed++;
      } else {
        filename = `${code}.csv`;
      }
      const csv = toCsv(headers, rowsForStore);
      zip.file(filename, csv);
      files++;
    }

    const blob = await zip.generateAsync({ type:'blob' });
    saveAs(blob, 'split_stores.zip');
    log(`Done. Files: ${files} (renamed by mapping: ${renamed}).`);
  }catch(err){
    console.error(err);
    alert('Something went wrong. Check console.');
  }
};
</script>
</body>
</html>
